#!/usr/bin/env python

import grass.script as gscript


def main():

    gscript.run_command('g.proj', epsg='32633', flags='c')
    gscript.run_command('g.region', overwrite=True, res='20', w='478000', e='528300', n='4190000', s='4141900', flags='p')
    '''##gscript.run_command('g.region', overwrite=True, res='20', n='37:53:00N', s='37:24:00N', e='15:16:00E', w='14:47:00E', flags='p')
    # Landuse map from http://download.geofabrik.de/europe/italy/isole.html
    gscript.run_command('v.import', input='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/gis_osm_landuse_a_free_1.shp', output='landuse', overwrite=True)
    #geojson download with script download.sh
    ##gscript.run_command('v.import', input='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/streets.geojson', output='streets', overwrite=True)
    ##gscript.run_command('v.import', input='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/buildings_way.geojson', output='buildings_way', overwrite=True)
    ##gscript.run_command('v.import', input='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/buildings_rel.geojson', output='buildings_rel', overwrite=True)
    gscript.run_command('v.import', input='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/gis_osm_buildings_a_free_1.shp', output='buildings', overwrite=True)
    gscript.run_command('v.import', input='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/gis_osm_roads_free_1.shp', output='roads', overwrite=True)
    
    gscript.run_command('v.in.region', overwrite=True, output='region')
    gscript.run_command('v.clip', overwrite=True, input='roads@PERMANENT', clip='region@PERMANENT', output='roads_region')
    gscript.run_command('v.clip', overwrite=True, input='buildings@PERMANENT', clip='region@PERMANENT', output='buildings_region')
    gscript.run_command('v.clip', overwrite=True, input='landuse@PERMANENT', clip='region@PERMANENT', output='landuse_region')
    #create grid for vulnerability calculation
   
    #roadpoints density
    gscript.run_command('v.mkgrid', map='roadpoints_density', position='region', box='100,100', overwrite=True)
    #gscript.run_command('v.to.points', input='roads@PERMANENT', type='line', output='roadpoints', dmax=50, overwrite=True)
    gscript.run_command('v.vect.stats', points='roadpoints@PERMANENT', areas='roadpoints_density@PERMANENT', count_column='roadpoints_count')#, type='point')
    gscript.run_command('v.to.rast', input='roadpoints_density@PERMANENT', output='roadpoints_density_raster', use='attr', attribute_column='roadpoints_count', overwrite=True, type='area')
    ##reclassify roadpoints density
    gscript.run_command('r.reclass', input='roadpoints_density_raster@PERMANENT', output='roadpoints_density_reclassified', rules='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/reclassification_roadpoints_density.txt', overwrite=True)
    gscript.run_command('r.resample', input='roadpoints_density_reclassified@PERMANENT', output='roadpoints_density_reclassified', overwrite=True)'''

    #create grid for calculation
    gscript.run_command('v.mkgrid', map='building_density', position='region', box='100,100', overwrite=True)
    ##count buildings per grid section
    gscript.run_command('v.vect.stats', points='buildings@PERMANENT', type='centroid', areas='building_density@PERMANENT', count_column='building_count')
    ##convert grid to raster with building density as raster value
    gscript.run_command('v.to.rast', input='building_density@PERMANENT', output='building_density_raster', use='attr', attribute_column='building_count', overwrite=True, type='area')
    ##reclassify building density
    gscript.run_command('r.reclass', input='building_density_raster@PERMANENT', output='building_density_reclassified', rules='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/reclassification_building_density.txt', overwrite=True)
    gscript.run_command('r.resample', input='building_density_reclassified@PERMANENT', output='building_density_reclassified', overwrite=True)

    #landuse
    gscript.run_command('v.reclass', input='landuse_region', output='landuse_region_reclassify', column='fclass', overwrite=True)
    gscript.run_command('v.to.rast', input='landuse_region_reclassify@PERMANENT', output='landuse_region_reclassify_raster', use='attr', attribute_column='cat', overwrite=True, type='area')
    #1 allotments, 2 cemetry, 3 commercial, 4 farm, 5 forest, 6 grass, 7 heath, 8 industrial, 9 meadow, 10 military, 11 nature_reserve, 12 orchard, 13 park, 14 quarry, 15 recreation_ground, 16 residential, 17 retail, 18 scrub, 19 vineyard
    gscript.run_command('r.reclass', input='landuse_region_reclassify_raster@PERMANENT', output='landuse_region_reclassify_raster2', rules='D:/Dokumente_D/Uni/5_Semester/GIS_Proseminar/project/fossgis_project/etna/reclassification_landuse.txt', overwrite=True)
    gscript.run_command('r.resample', input='landuse_region_reclassify_raster2@PERMANENT', output='landuse_region_reclassify_raster2', overwrite=True)
    gscript.run_command('r.null', map='landuse_region_reclassify_raster2@PERMANENT', null='1')

    #vulnerability analysis
    gscript.run_command('r.mapcalc', expression='vulnerability = building_density_reclassified@PERMANENT + roadpoints_density_reclassified@PERMANENT + landuse_region_reclassify_raster2@PERMANENT', overwrite=True)
if __name__ == '__main__':
    main()
